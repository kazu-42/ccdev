# 要件定義書

## Introduction

Claude Code Webセルフホスト版は、ブラウザベースのAI対話・コード実行環境です。Cloudflare Sandbox（Workers + Containers）を活用し、安全なコード実行環境を提供します。PWA対応により、スマートフォンからもアプリライクに利用可能です。

**ターゲットユーザー:**
- 個人開発者
- チーム開発での共有ツールとして
- モバイルからも軽量にコード実行したい人

**コアバリュー:**
- セルフホスト: 自分のCloudflareアカウントで完結
- セキュア: サンドボックス環境でのコード実行
- どこでも: PWA対応でスマホからも快適に利用

---

## Requirements

### Requirement 1: チャットインターフェース
**Objective:** As a ユーザー, I want AIとチャット形式で対話してコード作成・実行の支援を受けたい, so that 効率的にコーディング作業を進められる

#### Acceptance Criteria
1. システムはMarkdown形式のメッセージをレンダリングし、コードブロックをシンタックスハイライト付きで表示すること
2. When AIがレスポンスを生成するとき、システムはストリーミング形式でリアルタイムに表示すること
3. While セッション中、システムは会話履歴を保持し、コンテキストを維持すること
4. When コードが実行されたとき、システムは実行結果をメッセージ内にインラインで表示すること
5. システムはユーザーの入力を送信ボタンまたはEnterキーで送信できること
6. システムはメッセージの送信中にローディング状態を表示すること

---

### Requirement 2: コード実行環境（Sandbox）
**Objective:** As a ユーザー, I want AIが生成したコードを安全に実行したい, so that コードの動作を即座に確認できる

#### Acceptance Criteria
1. システムはJavaScript/TypeScriptコードをCloudflare Sandbox上で実行できること
2. システムはPythonコードをPyodide（WASM）経由で実行できること
3. When コード実行が30秒を超えたとき、システムはタイムアウトエラーを返すこと
4. システムはstdout/stderrの出力をキャプチャして表示すること
5. When コードがエラーを発生させたとき、システムはエラーメッセージとスタックトレースを表示すること
6. システムはサンドボックス環境でメモリ制限を適用し、リソース枯渇を防ぐこと
7. システムは悪意のあるコードの実行を隔離し、ホストシステムに影響を与えないこと

---

### Requirement 3: AI連携（Anthropic API）
**Objective:** As a ユーザー, I want Claude AIと対話してコーディング支援を受けたい, so that 高品質なコードを効率的に作成できる

#### Acceptance Criteria
1. システムはAnthropic API（Claude 3.5/4）と連携し、チャット機能を提供すること
2. システムはTool Use（Function Calling）を使用して、AIが自動的にコード実行を判定できること
3. When AIがコード実行ツールを呼び出したとき、システムは自動的にSandboxでコードを実行すること
4. システムはAPIレスポンスをストリーミング形式（SSE）で受信し、リアルタイム表示すること
5. システムはAPIキーをCloudflare Secretsで安全に管理すること
6. When API呼び出しがエラーを返したとき、システムは適切なエラーメッセージを表示すること

---

### Requirement 4: PWA対応
**Objective:** As a モバイルユーザー, I want スマートフォンでもアプリのように使いたい, so that 外出先でもコーディング作業ができる

#### Acceptance Criteria
1. システムはService Workerを実装し、基本的なオフライン機能を提供すること
2. システムはWeb App Manifest（manifest.json）を提供し、ホーム画面への追加をサポートすること
3. While オフライン時、システムは基本UIを表示し、オフライン状態を通知すること
4. システムはモバイルデバイスでのタッチ操作に最適化されたUIを提供すること
5. システムは初期ロードを3秒以内（3G回線）で完了すること
6. システムはアプリアイコンとスプラッシュスクリーンをサポートすること

---

### Requirement 5: バックエンドAPI
**Objective:** As a フロントエンド, I want 安定したAPIエンドポイントにアクセスしたい, so that AI対話とコード実行機能を利用できる

#### Acceptance Criteria
1. システムは `POST /api/chat` エンドポイントでAI対話をサポートし、SSEでストリーミングレスポンスを返すこと
2. システムは `POST /api/execute` エンドポイントでコード実行をサポートすること
3. システムはCORS設定により、許可されたオリジンからのアクセスのみを受け入れること
4. When 不正なリクエストを受けたとき、システムは適切なHTTPエラーコードとメッセージを返すこと
5. システムはレートリミットを実装し、過剰なリクエストを制限すること
6. システムはCloudflare Workersのエッジで実行され、低レイテンシを実現すること

---

### Requirement 6: セキュリティ
**Objective:** As a 運用者, I want セキュアなシステムを運用したい, so that ユーザーとシステムを保護できる

#### Acceptance Criteria
1. システムはすべてのコード実行をサンドボックス環境で隔離すること
2. システムはネットワークアクセスをホワイトリスト方式で制限すること
3. システムはユーザー入力をサニタイズし、インジェクション攻撃を防ぐこと
4. システムはAPIキーをCloudflare Secretsで管理し、コードに直接含めないこと
5. システムはHTTPS通信を強制し、データを暗号化すること
6. システムは実行ログを記録し、監査可能な状態を維持すること

---

### Requirement 7: パフォーマンス
**Objective:** As a ユーザー, I want 高速なレスポンスを得たい, so that ストレスなく作業できる

#### Acceptance Criteria
1. システムは初期ロードを3秒以内（3G回線）で完了すること
2. システムはコード実行を500ms以内（コールドスタート含む）で開始すること
3. システムはAIストリーミングレスポンスを1秒以内に開始すること
4. システムはCloudflare Workersのグローバルエッジデプロイにより、地理的に近いエッジで処理すること
5. システムはPyodideの初期ロードをバックグラウンドで行い、ユーザー体験を阻害しないこと

---

### Requirement 8: デプロイメント
**Objective:** As a 開発者, I want 簡単にセルフホストでデプロイしたい, so that 自分のCloudflareアカウントで運用できる

#### Acceptance Criteria
1. システムは `pnpm install && pnpm deploy` でデプロイ可能であること
2. システムはCloudflare Workersにデプロイされ、カスタムドメインをサポートすること
3. システムはD1（SQLite）とKVをストレージとして使用し、追加のデータベース設定を不要とすること
4. システムはwrangler.tomlで設定を管理し、環境ごとの設定変更を容易にすること
5. システムはGitHub Actions等のCI/CDパイプラインとの統合をサポートすること

---

## 非機能要件サマリー

| カテゴリ | 要件 |
|---------|------|
| パフォーマンス | 初期ロード < 3秒、コード実行開始 < 500ms、AIレスポンス開始 < 1秒 |
| 可用性 | Cloudflare Workersのグローバルエッジ、99.9%可用性目標 |
| スケーラビリティ | Cloudflare Workers自動スケール |
| セキュリティ | サンドボックス隔離、HTTPS強制、入力サニタイズ |

---

## 将来拡張（Phase 2以降）

1. 仮想ファイルシステム
2. 複数言語対応拡張（Go, Rust via WASM）
3. 会話履歴のKV/D1永続化
4. Monaco Editorによるコード編集モード
5. マルチユーザー認証（Cloudflare Access）
6. 共有ワークスペース
7. R2へのファイル保存
