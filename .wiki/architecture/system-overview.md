# システムアーキテクチャ

## 概要

Claude Code Webは、Edge-First Monolithアーキテクチャを採用しています。フロントエンドとバックエンドを単一リポジトリで管理し、Cloudflare Workersでバックエンドをエッジデプロイします。

---

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                         クライアント                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              PWA (React + Vite)                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ Chat UI     │  │ Pyodide     │  │ Service Worker  │   │  │
│  │  │ (Markdown)  │  │ (WASM)      │  │ (Cache)         │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS (WebSocket for streaming)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Cloudflare Edge                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Cloudflare Workers (API Gateway)             │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ /api/chat   │  │ /api/exec   │  │ Middleware      │   │  │
│  │  │ (AI対話)    │  │ (コード実行)│  │ (CORS, Error)   │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│         ┌────────────────────┼────────────────────┐             │
│         ▼                    ▼                    ▼             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐     │
│  │ Anthropic   │      │ Cloudflare  │      │ D1 / KV     │     │
│  │ API         │      │ Sandbox     │      │ Storage     │     │
│  └─────────────┘      └─────────────┘      └─────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成

### クライアント層

| コンポーネント | 技術 | 責務 |
|--------------|------|------|
| Chat UI | React + Zustand | AI対話インターフェース |
| Pyodide | WASM | クライアントサイドPython実行 |
| Service Worker | Workbox | PWAキャッシュ・オフライン |

### エッジ層

| コンポーネント | 技術 | 責務 |
|--------------|------|------|
| API Gateway | Hono on Workers | リクエストルーティング |
| AnthropicService | SDK | Claude API連携 |
| SandboxService | Sandbox SDK | コード実行隔離 |
| Middleware | Hono | CORS, エラーハンドリング |

### ストレージ層

| コンポーネント | 技術 | 用途 |
|--------------|------|------|
| D1 | SQLite | 会話履歴永続化 |
| Workers KV | Key-Value | セッション管理 |

---

## ドメイン境界

システムは以下の3つのドメインに分割されています：

### 1. Chat Domain
- **責務**: AI対話の管理
- **含まれるもの**: メッセージ、会話、Tool Use
- **データ**: Message, Conversation

### 2. Sandbox Domain
- **責務**: コード実行の隔離と管理
- **含まれるもの**: JS/TS実行、Python実行、結果取得
- **データ**: ExecutionResult, CodeBlock

### 3. Storage Domain
- **責務**: 永続化とセッション管理
- **含まれるもの**: 会話保存、セッション追跡
- **データ**: Session, StoredConversation

---

## 通信プロトコル

### クライアント ↔ Workers

| エンドポイント | プロトコル | 用途 |
|--------------|-----------|------|
| POST /api/chat | SSE (Server-Sent Events) | AIストリーミングレスポンス |
| POST /api/execute | REST | コード実行 |

### Workers ↔ 外部サービス

| 接続先 | プロトコル | 認証 |
|-------|-----------|------|
| Anthropic API | HTTPS | API Key (Secrets) |
| Cloudflare Sandbox | SDK | Workers Binding |

---

## スケーラビリティ

Cloudflare Workersの特性により、以下のスケーラビリティを自動的に獲得：

- **水平スケール**: 自動（Workersの分散実行）
- **地理的分散**: グローバルエッジ（200+ ロケーション）
- **コールドスタート**: <5ms（V8 Isolates）

---

## 関連ドキュメント

- [データフロー](./data-flow.md)
- [セキュリティモデル](./security.md)
- [ADR-001: Cloudflare Sandbox SDK](../decisions/adr-001-cloudflare-sandbox.md)
